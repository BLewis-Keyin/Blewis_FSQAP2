<!DOCTYPE html>
<html>

<head>
    <title>Chat Room</title>
    <link rel="stylesheet" type="text/css" href="./styles.css">
    <script src="./navigation.js" type="module"></script>
    <script type="module">
        import { injectNavigationMenu } from './navigation.js'; injectNavigationMenu('menu-placeholder');
    </script>
</head>

<body>
    <div id="menu-placeholder2">
        <h3>Chat Rooms</h3>
        <ul>
            <li><a href="#room1" id="chat-room-1">Room 1</a></li>
            <li><a href="#room2" id="chat-room-2">Room 2</a></li>
            <li><a href="#room3" id="chat-room-3">Room 3</a></li>
        </ul>
    </div>

    <div id="chat-box">
        <!-- Chat messages will be displayed here -->
    </div>

    <input type="text" id="message-input" placeholder="Type your message...">
    <button id="send-button">Send</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // Store messages for different chat rooms
        const chatRooms = {
            room1: ['This is an example chat room feature', 'Messages are stored into a room array, and displayed here', 'Each chat room has its own array, and switching between chat rooms will update the chat box to reflect the new room'],
            room2: [],
            room3: [],
        };

        // Function to switch chat rooms
        function switchChatRoom(room) {
            chatBox.innerHTML = ''; // Clear the chat box

            // Fetch the chat history for the room
            socket.emit('join room', room);

            // Listen for chat history from the server
            socket.on('chat history', (history) => {
                chatRooms[room] = history;
                chatBox.innerHTML = '';
                history.forEach((msg) => {
                    const messageElement = document.createElement('p');
                    messageElement.textContent = msg;
                    chatBox.appendChild(messageElement);
                });
            });
        }

        // Listen for incoming messages from the server
        socket.on('chat message', (data) => {
            const {
                room,
                message
            } = data;
            chatRooms[room].push(message);
            if (room === getCurrentRoom()) {
                const messageElement = document.createElement('p');
                messageElement.textContent = message;
                chatBox.appendChild(messageElement);
            }
        });

        // Function to get the current chat room 
        function getCurrentRoom() {
            const currentHash = window.location.hash; // Get the current URL hash
            const roomName = currentHash.slice(1);
            return roomName || 'room1';
        }

        // Function to send a message
        function sendMessage() {
            console.log(chatRooms)
            const message = messageInput.value;
            const room = getCurrentRoom();
            console.log(room)
            if (message) {
                socket.emit('chat message', {
                    room,
                    message
                });
            }
        }

        sendButton.addEventListener('click', sendMessage);

        // Update the chat box when the URL hash changes
        window.addEventListener('hashchange', () => {
            switchChatRoom(getCurrentRoom());
        });

        // Initialize the chat box for the current room
        switchChatRoom(getCurrentRoom());

        const roomLinks = document.querySelectorAll('#menu-placeholder ul li a');
        roomLinks.forEach((link) => {
            link.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent the default behavior of links
                const roomName = link.getAttribute('href').slice(1); // Get the room name from the href attribute
                window.location.hash = roomName; // Update the URL hash
                switchChatRoom(roomName); // Switch to the selected room
            });
        });
    </script>
</body>

</html>